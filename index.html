<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leaderboard - Tournoi Clan</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --bg:#071018;
    --card:#071826;
    --accent:#3dd1ff;
    --accent-2:#6ad1ff;
    --muted:#9aa6b2;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;background:
    radial-gradient(800px 400px at 10% 10%, rgba(61,209,255,0.03), transparent 6%),
    linear-gradient(180deg,#071018 0%, #05060a 100%);
    color:#e6f3fb;font-family:Inter,system-ui,Roboto,Arial;}
  .wrap{max-width:1100px;margin:28px auto;display:grid;grid-template-columns:260px 1fr 260px;gap:18px;padding:18px;}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid var(--glass);padding:16px;border-radius:12px;box-shadow:0 8px 30px rgba(58,150,255,0.03);}
  .left,.right{min-height:160px;}
  .center{padding:18px;}
  h1{margin:0 0 8px 0;color:var(--accent-2);font-size:18px;}
  .muted{color:var(--muted);font-size:13px;}
  input[type="password"], input[type="text"], input[type="number"]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;box-sizing:border-box;}
  button{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:0;padding:9px 12px;border-radius:10px;color:#02121a;font-weight:700;cursor:pointer;}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 10px;}
  .row{display:flex;gap:8px;align-items:center;}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px;}
  thead th{font-weight:600;text-align:left;padding:10px 8px;color:var(--muted);font-size:12px;border-bottom:1px solid rgba(255,255,255,0.03);}
  td{padding:12px 8px;border-bottom:1px solid rgba(255,255,255,0.02);vertical-align:middle;}
  .avatar{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#0b1b26,#07202a);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent-2);margin-right:10px;}
  .score{font-weight:800;color:#fff;text-align:right;width:120px;}
  .controls{display:flex;gap:8px;align-items:center;}
  .empty{opacity:0.45;text-align:center;padding:28px;border:1px dashed rgba(255,255,255,0.03);border-radius:10px;color:var(--muted);margin-top:12px;}
  @media (max-width:980px){.wrap{grid-template-columns:1fr;padding:12px;} .right{order:3}}
  
  body{box-sizing:border-box;}
  .wrap{padding:18px;}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel left" id="leftPanel">
    <h1>Administration</h1>
    <div class="muted">Connexion admin</div>
    <div style="margin-top:10px;">
      <input id="adminPw" type="password" placeholder="Mot de passe admin">
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;">
      <button id="btnLogin">Se connecter</button>
      <button id="btnLogout" class="ghost" style="display:none;">Se d√©connecter</button>
    </div>
    <div id="adminInfo" class="muted" style="margin-top:10px;">Vue participant par d√©faut.</div>

    <div id="adminAddForm" style="display:none;margin-top:14px;">
      <h3 style="margin:0 0 8px 0;color:var(--accent-2);font-size:15px;">Ajouter un joueur</h3>
      <input id="newName" type="text" placeholder="Nom du joueur" style="margin-bottom:8px;">
      <input id="newScore" type="number" placeholder="Score initial" value="0" style="margin-bottom:8px;">
      <div style="display:flex;gap:8px;">
        <button id="confirmAdd">Ajouter</button>
        <button id="btnReset" class="ghost">R√©initialiser</button>
      </div>
    </div>
  </div>

  <div class="panel center">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <h1>Classement du tournoi</h1>
        <div id="countInfo" class="muted">0 joueurs</div>
      </div>
      <div class="controls">
        <button id="btnAddPlayer" class="ghost" style="display:none;">Formulaire</button>
      </div>
    </div>

    <div id="boardArea">
      <table aria-label="Leaderboard">
        <thead>
          <tr>
            <th style="width:60px">Rang</th>
            <th>Joueur</th>
            <th style="text-align:right">Points</th>
            <th style="text-align:right" id="thActions">Actions</th>
          </tr>
        </thead>
        <tbody id="boardBody"></tbody>
      </table>

      <div id="emptyNotice" class="empty" style="display:none;">Aucun joueur pour le moment.</div>
    </div>
  </div>

  <div class="panel right" id="rightPanel" style="display:flex;flex-direction:column;align-items:center;justify-content:center;">
    <img src="https://i.imgur.com/w5zbkQJ.png" alt="logo clan" style="width:160px;height:160px;object-fit:contain;filter:drop-shadow(0 0 40px rgba(61,209,255,0.25));">
    <div class="muted" style="margin-top:12px;text-align:center;"> </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>

  const firebaseConfig = {
    apiKey: "AIzaSyBW4Kb27bN5-Vjo5c58R6b_zp3I4d9oLGU",
    authDomain: "tournois-d2.firebaseapp.com",
    databaseURL: "https://tournois-d2-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "tournois-d2",
    storageBucket: "tournois-d2.firebasestorage.app",
    messagingSenderId: "585069698492",
    appId: "1:585069698492:web:3a3082516f6ea607a11fb9",
    measurementId: "G-6B18YR4F5W"
  };


  (function initFirebaseSafe(){
    let tries = 0;
    function tryInit(){
      tries++;
      if (typeof firebase !== 'undefined' && typeof firebase.initializeApp === 'function') {
        try {
          if (!firebase.apps || firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
          }
          window.db = firebase.database();
          console.log('Firebase initialis√© ‚Äî db pr√™te.');
          window.dispatchEvent(new Event('firebase-db-ready'));
        } catch(e) {
          console.error('Erreur init Firebase', e);
        }
      } else {
        if (tries < 12) setTimeout(tryInit, 300);
        else console.error('Firebase non charg√© apr√®s plusieurs tentatives.');
      }
    }
    tryInit();
  })();
</script>


<script>

const ADMIN_PASSWORD = atob("YWRtaW4xMjM=");
window.ADMIN_PASSWORD = ADMIN_PASSWORD; 

function qs(id){ return document.getElementById(id); }
function formatScore(n){ return Number(n||0).toLocaleString('fr-FR'); }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function genId(){ return 'p'+Math.random().toString(36).slice(2,9); }
function parseSigned(str){ if(!str) return null; const m = str.replace(/\s+/g,'').match(/^([+-])(\d+)$/); if(!m) return null; return (m[1] === '+' ? 1 : -1) * parseInt(m[2],10); }


const adminPw = qs('adminPw');
const btnLogin = qs('btnLogin');
const btnLogout = qs('btnLogout');
const adminInfo = qs('adminInfo');
const btnAddPlayer = qs('btnAddPlayer');
const adminAddForm = qs('adminAddForm');
const confirmAdd = qs('confirmAdd');
const newName = qs('newName');
const newScore = qs('newScore');
const boardBody = qs('boardBody');
const countInfo = qs('countInfo');
const emptyNotice = qs('emptyNotice');
const btnReset = qs('btnReset');
const thActions = qs('thActions');


let players = [];
let isAdmin = false;

function whenDbReady(fn){
  if (window.db) return fn();
  window.addEventListener('firebase-db-ready', fn, { once: true });
}

whenDbReady(() => {
  const playersRef = window.db.ref('players');
  playersRef.on('value', snapshot => {
    const data = snapshot.val() || {};
    players = Object.keys(data).map(k => ({ id: k, ...data[k] }));
    render();
  }, err => {
    console.error('Erreur DB listener', err);

    if (err && err.code === 'PERMISSION_DENIED') {
      alert('Erreur: acc√®s √† la base de donn√©es refus√©. V√©rifie les r√®gles Realtime Database.');
    }
  });
});


function render(){
  players.sort((a,b)=> (b.score||0) - (a.score||0) || (a.createdAt||0) - (b.createdAt||0));
  boardBody.innerHTML = '';
  thActions.style.display = isAdmin ? "" : "none";
  countInfo.textContent = players.length + ' joueur' + (players.length>1?'s':'');
  emptyNotice.style.display = players.length === 0 ? 'block' : 'none';

  players.forEach((p, idx) => {
    const tr = document.createElement('tr');
    if(idx === 0) tr.style.background = 'linear-gradient(90deg, rgba(255,215,0,0.03), transparent)';
    const tdRank = document.createElement('td');
    tdRank.style.fontWeight = '700';
    tdRank.innerHTML = (idx<3?'<span style="margin-right:6px">üèÜ</span>':'') + (idx+1);
    tr.appendChild(tdRank);

    const tdName = document.createElement('td');
    const wrap = document.createElement('div');
    wrap.style.display = 'flex';
    wrap.style.alignItems = 'center';
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = (p.name||'').slice(0,2).toUpperCase();
    const nameWrap = document.createElement('div');
    nameWrap.innerHTML = '<div style="font-weight:700">'+escapeHtml(p.name||'')+'</div>';
    wrap.appendChild(avatar);
    wrap.appendChild(nameWrap);
    tdName.appendChild(wrap);
    tr.appendChild(tdName);

    const tdScore = document.createElement('td');
    tdScore.className = 'score';
    tdScore.textContent = formatScore(p.score || 0);
    tr.appendChild(tdScore);

    const tdActions = document.createElement('td');
    tdActions.style.textAlign = 'right';

    if(isAdmin){
      const input = document.createElement('input');
      input.className = 'input-inline';
      input.placeholder = '+10 ou -5';
      input.style.width = '110px';
      input.style.marginRight = '8px';

      const applyBtn = document.createElement('button');
      applyBtn.textContent = 'Appliquer';
      applyBtn.style.marginRight = '6px';
      applyBtn.onclick = async ()=> {
        const val = input.value.trim();
        if(!val){ alert('Entrez +N ou -N'); return; }
        const parsed = parseSigned(val);
        if(parsed === null){ alert('Format invalide. Exemple: +10 ou -5'); return; }
        const newScore = Math.max(0, (p.score || 0) + parsed);
        try { await window.db.ref('players/' + p.id + '/score').set(newScore); } catch(err){ console.error(err); alert('Erreur √©criture'); }
      };

      const editBtn = document.createElement('button');
      editBtn.className = 'ghost';
      editBtn.textContent = 'Modifier nom';
      editBtn.style.marginRight = '6px';
      editBtn.onclick = async ()=> {
        const newN = prompt('Nouveau nom pour '+p.name, p.name);
        if(newN && newN.trim()){
          try { await window.db.ref('players/' + p.id + '/name').set(newN.trim()); } catch(err){ console.error(err); alert('Erreur √©criture'); }
        }
      };

      const delBtn = document.createElement('button');
      delBtn.className = 'ghost';
      delBtn.textContent = 'Supprimer';
      delBtn.onclick = async ()=> {
        if(confirm('Supprimer '+p.name+' du classement ?')){
          try { await window.db.ref('players/' + p.id).remove(); } catch(err){ console.error(err); alert('Erreur suppression'); }
        }
      };

      tdActions.appendChild(input);
      tdActions.appendChild(applyBtn);
      tdActions.appendChild(editBtn);
      tdActions.appendChild(delBtn);
    }

    tr.appendChild(tdActions);
    boardBody.appendChild(tr);
  });
}


btnLogin.addEventListener('click', ()=> {
  const val = (adminPw.value || '').toString().trim();
  if(val === ADMIN_PASSWORD){
    isAdmin = true;
    adminInfo.textContent = "Connect√© en tant qu'admin";
    btnLogin.style.display = 'none';
    btnLogout.style.display = 'inline-block';
    adminAddForm.style.display = 'block';
    btnAddPlayer.style.display = 'inline-block';
    btnReset.style.display = 'inline-block';
    adminPw.value = '';
    render();
  } else {
    alert('Mot de passe incorrect');
  }
});

btnLogout.addEventListener('click', ()=> {
  isAdmin = false;
  adminInfo.textContent = 'Vue participant par d√©faut.';
  btnLogin.style.display = 'inline-block';
  btnLogout.style.display = 'none';
  adminAddForm.style.display = 'none';
  btnAddPlayer.style.display = 'none';
  btnReset.style.display = 'none';
  render();
});


btnAddPlayer.addEventListener('click', ()=> { adminAddForm.style.display = adminAddForm.style.display === 'none' ? 'block' : 'none'; });

confirmAdd.addEventListener('click', async ()=> {
  if(!isAdmin){ alert('Acc√®s admin requis'); return; }
  const name = (newName.value || '').trim();
  const score = Number(newScore.value || 0);
  if(!name){ alert('Nom requis'); return; }
  const id = genId();
  const p = { name: name, score: Math.max(0, Math.floor(score)), createdAt: Date.now() };
  try { await window.db.ref('players/' + id).set(p); newName.value = ''; newScore.value = '0'; } catch(err){ console.error(err); alert("Impossible d'ajouter le joueur. V√©rifie les r√®gles DB."); }
});

btnReset.addEventListener('click', async ()=> {
  if(!isAdmin){ alert('Acc√®s admin requis'); return; }
  if(confirm('R√©initialiser tout le leaderboard ? (action irr√©versible)')){
    try { await window.db.ref('players').remove(); } catch(err){ console.error(err); alert('Impossible de r√©initialiser.'); }
  }
});


adminAddForm.style.display = 'none';
btnAddPlayer.style.display = 'none';
btnReset.style.display = 'none';
render();
</script>
</body>
</html>



